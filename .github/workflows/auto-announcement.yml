name: Auto Announcement on Deploy

on:
  push:
    branches:
      - main  # λλ” λ°°ν¬ λΈλμΉ μ΄λ¦„
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'

jobs:
  create-announcement:
    runs-on: ubuntu-latest
    if: github.event.head_commit.message != '' && !contains(github.event.head_commit.message, '[skip-announcement]')
    
    steps:
      - name: Extract commit message
        id: commit
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
      
      - name: Parse version from commit
        id: version
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          # λ²„μ „ ν•μ‹ μ¶”μ¶ (μ: v1.2.3, version 1.2.3, 1.2.3)
          VERSION=$(echo "$COMMIT_MSG" | grep -oE '(v?[0-9]+\.[0-9]+\.[0-9]+|version [0-9]+\.[0-9]+\.[0-9]+)' | head -1 | sed 's/version //' | sed 's/^v//')
          if [ -z "$VERSION" ]; then
            # λ²„μ „μ΄ μ—†μΌλ©΄ λ‚ μ§ ν•μ‹ μ‚¬μ©
            VERSION=$(date +'%Y-%m-%d')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create announcement
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ANNOUNCEMENT_API_KEY: ${{ secrets.ANNOUNCEMENT_API_KEY }}
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # μ»¤λ°‹ λ©”μ‹μ§€λ¥Ό μ„μ‹ νμΌμ— μ €μ¥ (λ©€ν‹°λΌμΈ μ²λ¦¬μ©)
          echo "$COMMIT_MSG" > /tmp/commit_msg.txt
          
          # μ²« μ¤„μ„ μ λ©μΌλ΅ μ‚¬μ© (λ²„μ „ μ •λ³΄ μ κ±°)
          TITLE=$(head -1 /tmp/commit_msg.txt | sed 's/^# //' | sed 's/^v[0-9]\+\.[0-9]\+\.[0-9]\+: //' | sed 's/^version [0-9]\+\.[0-9]\+\.[0-9]\+: //' | sed 's/^\[.*\] //' | cut -c1-100)
          
          # λ‘ λ²μ§Έ μ¤„λ¶€ν„° λΉ μ¤„μ„ μ μ™Έν•κ³  λ‚΄μ© μ¶”μ¶
          # awkλ¥Ό μ‚¬μ©ν•μ—¬ λΉ μ¤„μ„ μ μ™Έν•κ³  μ²« λ²μ§Έ λΉ„μ–΄μμ§€ μ•μ€ μ¤„λ¶€ν„° μµλ€ 500μκΉμ§€ μ¶”μ¶
          CONTENT=$(tail -n +2 /tmp/commit_msg.txt | awk 'NF > 0 {print; count++; if (count >= 3) exit}' | tr '\n' ' ' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | cut -c1-500)
          
          # λ‚΄μ©μ΄ λΉ„μ–΄μκ±°λ‚ λ„λ¬΄ μ§§μΌλ©΄ κΈ°λ³Έ λ©”μ‹μ§€ μ‚¬μ©
          if [ -z "$CONTENT" ] || [ ${#CONTENT} -lt 5 ]; then
            CONTENT="μƒλ΅μ΄ μ—…λ°μ΄νΈκ°€ λ°°ν¬λμ—μµλ‹λ‹¤."
          fi
          
          # JSON μ΄μ¤μΌ€μ΄ν”„ μ²λ¦¬ (νΉμ λ¬Έμ μ²λ¦¬)
          TITLE_ESCAPED=$(echo "$TITLE" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g' | sed "s/'/\\'/g")
          CONTENT_ESCAPED=$(echo "$CONTENT" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g' | sed "s/'/\\'/g")
          
          echo "π“ κ³µμ§€μ‚¬ν•­ μƒμ„± μ¤‘..."
          echo "μ λ©: $TITLE"
          echo "λ‚΄μ©: $CONTENT"
          echo "λ²„μ „: $VERSION"
          
          # Edge Function νΈμ¶
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$SUPABASE_URL/functions/v1/create-announcement" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "x-api-key: $ANNOUNCEMENT_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"title\": \"$TITLE_ESCAPED\",
              \"content\": \"$CONTENT_ESCAPED\",
              \"version\": \"$VERSION\",
              \"priority\": 10
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "β… κ³µμ§€μ‚¬ν•­μ΄ μ„±κ³µμ μΌλ΅ μƒμ„±λμ—μµλ‹λ‹¤!"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
          else
            echo "β κ³µμ§€μ‚¬ν•­ μƒμ„± μ‹¤ν¨ (HTTP $HTTP_CODE)"
            echo "μ‘λ‹µ: $BODY"
            echo "μ”μ²­ λ°μ΄ν„°:"
            echo "  μ λ©: $TITLE_ESCAPED"
            echo "  λ‚΄μ©: $CONTENT_ESCAPED"
            echo "  λ²„μ „: $VERSION"
            exit 1
          fi
          
          # μ„μ‹ νμΌ μ •λ¦¬
          rm -f /tmp/commit_msg.txt
      
      - name: Announcement created
        run: |
          echo "β… κ³µμ§€μ‚¬ν•­μ΄ μλ™μΌλ΅ μƒμ„±λμ—μµλ‹λ‹¤!"
          echo "λ²„μ „: ${{ steps.version.outputs.version }}"
