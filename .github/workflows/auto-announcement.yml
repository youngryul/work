name: Auto Announcement on Deploy

on:
  push:
    branches:
      - main  # ë˜ëŠ” ë°°í¬ ë¸Œëœì¹˜ ì´ë¦„
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'

jobs:
  create-announcement:
    runs-on: ubuntu-latest
    if: github.event.head_commit.message != '' && !contains(github.event.head_commit.message, '[skip-announcement]')
    
    steps:
      - name: Extract commit message
        id: commit
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # ë©€í‹°ë¼ì¸ ì¶œë ¥ì„ ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ê°œí–‰ ë¬¸ìë¥¼ ì´ìŠ¤ì¼€ì´í”„)
          COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed ':a;N;$!ba;s/\n/%0A/g')
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Parse version from commit
        id: version
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          # ë²„ì „ í˜•ì‹ ì¶”ì¶œ (ì˜ˆ: v1.2.3, version 1.2.3, 1.2.3)
          VERSION=$(echo "$COMMIT_MSG" | grep -oE '(v?[0-9]+\.[0-9]+\.[0-9]+|version [0-9]+\.[0-9]+\.[0-9]+)' | head -1 | sed 's/version //' | sed 's/^v//')
          if [ -z "$VERSION" ]; then
            # ë²„ì „ì´ ì—†ìœ¼ë©´ ë‚ ì§œ í˜•ì‹ ì‚¬ìš©
            VERSION=$(date +'%Y-%m-%d')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create announcement
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ANNOUNCEMENT_API_KEY: ${{ secrets.ANNOUNCEMENT_API_KEY }}
        run: |
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì„ì‹œ íŒŒì¼ì— ì €ì¥ (ë©€í‹°ë¼ì¸ ì²˜ë¦¬ìš©)
          echo "$COMMIT_MSG" > /tmp/commit_msg.txt
          
          # ì²« ì¤„ì„ ì œëª©ìœ¼ë¡œ ì‚¬ìš© (ë²„ì „ ì •ë³´ ì œê±°)
          TITLE=$(head -1 /tmp/commit_msg.txt | sed 's/^# //' | sed 's/^v[0-9]\+\.[0-9]\+\.[0-9]\+: //' | sed 's/^version [0-9]\+\.[0-9]\+\.[0-9]\+: //' | sed 's/^\[.*\] //' | cut -c1-100)
          
          # ë‘ ë²ˆì§¸ ì¤„ë¶€í„° ë¹ˆ ì¤„ì„ ì œì™¸í•˜ê³  ë‚´ìš© ì¶”ì¶œ
          # awkë¥¼ ì‚¬ìš©í•˜ì—¬ ë¹ˆ ì¤„ì„ ì œì™¸í•˜ê³  ì²« ë²ˆì§¸ ë¹„ì–´ìˆì§€ ì•Šì€ ì¤„ë¶€í„° ìµœëŒ€ 500ìê¹Œì§€ ì¶”ì¶œ
          CONTENT=$(tail -n +2 /tmp/commit_msg.txt | awk 'NF > 0 {print; count++; if (count >= 3) exit}' | tr '\n' ' ' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | cut -c1-500)
          
          # ë‚´ìš©ì´ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì§§ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
          if [ -z "$CONTENT" ] || [ ${#CONTENT} -lt 5 ]; then
            CONTENT="ìƒˆë¡œìš´ ì—…ë°ì´íŠ¸ê°€ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi
          
          # JSON ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ (íŠ¹ìˆ˜ ë¬¸ì ì²˜ë¦¬)
          TITLE_ESCAPED=$(echo "$TITLE" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g' | sed "s/'/\\'/g")
          CONTENT_ESCAPED=$(echo "$CONTENT" | sed 's/"/\\"/g' | sed 's/\\/\\\\/g' | sed "s/'/\\'/g")
          
          echo "ğŸ“ ê³µì§€ì‚¬í•­ ìƒì„± ì¤‘..."
          echo "ì œëª©: $TITLE"
          echo "ë‚´ìš©: $CONTENT"
          echo "ë²„ì „: $VERSION"
          
          # Edge Function í˜¸ì¶œ
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$SUPABASE_URL/functions/v1/create-announcement" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "x-api-key: $ANNOUNCEMENT_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"title\": \"$TITLE_ESCAPED\",
              \"content\": \"$CONTENT_ESCAPED\",
              \"version\": \"$VERSION\",
              \"priority\": 10
            }")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
          else
            echo "âŒ ê³µì§€ì‚¬í•­ ìƒì„± ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            echo "ì‘ë‹µ: $BODY"
            echo "ìš”ì²­ ë°ì´í„°:"
            echo "  ì œëª©: $TITLE_ESCAPED"
            echo "  ë‚´ìš©: $CONTENT_ESCAPED"
            echo "  ë²„ì „: $VERSION"
            exit 1
          fi
          
          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm -f /tmp/commit_msg.txt
      
      - name: Announcement created
        run: |
          echo "âœ… ê³µì§€ì‚¬í•­ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ë²„ì „: ${{ steps.version.outputs.version }}"
